<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopyShark - Intelligent Copy Generator</title>
    <style>
        :root { --primary: #667eea; --primary-dark: #5a67d8; --success: #10b981; --error: #ef4444; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-700: #374151; --gray-800: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--gray-100); color: var(--gray-800); margin: 0; display: flex; justify-content: center; align-items: flex-start; padding: 40px; min-height: 100vh; }
        .container { width: 100%; max-width: 900px; }
        .panel { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .auth-panel { max-width: 420px; margin: auto; }
        h1, h2 { text-align: center; color: var(--primary); margin-top: 0; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
        .btn:hover:not(:disabled) { background: var(--primary-dark); }
        .btn:disabled { background: #9fa6b2; cursor: not-allowed; }
        .link { text-align: center; margin-top: 20px; font-size: 14px; }
        .link a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .error-message { background-color: #fee2e2; color: #b91c1c; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; text-align: center; }
        .results-panel { margin-top: 30px; }
        .result-card { border: 1px solid var(--gray-200); border-left: 4px solid var(--primary); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .result-card h3 { margin-top: 0; font-size: 14px; text-transform: uppercase; color: var(--primary); }
        .result-card p { margin: 0; white-space: pre-wrap; }
        [hidden] { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-view">
            <div id="login-panel" class="panel auth-panel">
                <h1>Welcome Back</h1><div id="login-error" class="error-message" hidden></div>
                <form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div><button type="submit" class="btn">Login</button></form>
                <div class="link">No account? <a href="#" id="show-register">Register</a></div>
            </div>
            <div id="register-panel" class="panel auth-panel" hidden>
                <h1>Create Account</h1><div id="register-error" class="error-message" hidden></div>
                <form id="register-form"><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div><button type="submit" class="btn">Create Account</button></form>
                <div class="link">Have an account? <a href="#" id="show-login">Login</a></div>
            </div>
        </div>
        <div id="app-view" class="panel" hidden>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>ðŸ¦ˆ CopyShark</h1><button id="logout-btn" class="btn" style="width: auto; padding: 8px 16px; font-size: 14px; background: var(--gray-700);">Logout</button>
            </div>
            <div id="user-info" style="text-align: center; padding: 10px; background: #eee; border-radius: 8px; margin-bottom: 20px;"></div>
            <div id="upgrade-section" hidden><p>You are on the Free plan. <strong>Upgrade to Pro</strong> for unlimited generations!</p><button id="upgrade-btn" class="btn" style="background-color: var(--success); margin-top: 10px;">Upgrade Now</button></div>
            <form id="generator-form"><h2 style="margin-bottom: 20px;">Generate New Copy</h2><div class="form-group"><label for="productName">Product/Service Name</label><input type="text" id="productName" required></div><div class="form-group"><label for="audience">Target Audience</label><input type="text" id="audience" required></div><div class="form-group"><label for="niche">Niche</label><select id="niche" required></select></div><div class="form-group"><label for="framework">Framework</label><select id="framework" required></select></div><div class="form-group"><label for="tone">Tone</label><select id="tone" required><option value="professional">Professional</option><option value="casual">Casual</option><option value="urgent">Urgent</option></select></div><button type="submit" id="generate-btn" class="btn">Generate Copy</button></form>
            <div id="results-panel" class="results-panel" hidden><h2>Results</h2><div id="results-display"></div></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ui = {
                authView: document.getElementById('auth-view'), appView: document.getElementById('app-view'),
                loginPanel: document.getElementById('login-panel'), registerPanel: document.getElementById('register-panel'),
                userInfo: document.getElementById('user-info'), upgradeSection: document.getElementById('upgrade-section'),
                generateBtn: document.getElementById('generate-btn'), resultsPanel: document.getElementById('results-panel'),
                resultsDisplay: document.getElementById('results-display')
            };
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthPanels(false); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthPanels(true); });
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('generator-form').addEventListener('submit', handleGenerateCopy);
            document.getElementById('upgrade-btn').addEventListener('click', handleUpgrade);
            
            initializeApp();

            async function initializeApp() {
                if (getToken()) {
                    await showAppView();
                    await populateSelects();
                    await updateUserInfo();
                } else {
                    showAuthView();
                }
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('checkout') === 'success') {
                    alert('Payment successful! You are now on the Pro plan.');
                    window.history.pushState({}, '', '/'); // Clean URL
                    updateUserInfo();
                }
            }

            async function handleRegister(e) { /* ... same as before ... */ }
            async function handleLogin(e) { /* ... same as before ... */ }
            function handleLogout() { localStorage.removeItem('authToken'); showAuthView(); }
            
            async function handleGenerateCopy(e) {
                e.preventDefault();
                ui.generateBtn.disabled = true; ui.generateBtn.textContent = 'Generating...';
                const body = {
                    productName: document.getElementById('productName').value, audience: document.getElementById('audience').value,
                    niche: document.getElementById('niche').value, framework: document.getElementById('framework').value,
                    tone: document.getElementById('tone').value,
                };
                const { success, copy, error, requiresUpgrade } = await apiCall('/api/generate-copy', 'POST', body, true);
                if (success) {
                    displayResults(copy);
                } else {
                    if (requiresUpgrade) ui.upgradeSection.hidden = false;
                    alert(`Error: ${error}`);
                }
                ui.generateBtn.disabled = false; ui.generateBtn.textContent = 'Generate Copy';
            }

            async function handleUpgrade() {
                const { success, url, error } = await apiCall('/api/payments/create-checkout-session', 'POST', {}, true);
                if (success) window.location.href = url; else alert(`Error: ${error}`);
            }

            function toggleAuthPanels(showLogin) { /* ... same as before ... */ }
            function showAuthView() { ui.appView.hidden = true; ui.authView.hidden = false; toggleAuthPanels(true); }
            
            async function showAppView() {
                ui.authView.hidden = true;
                ui.appView.hidden = false;
            }
            
            async function updateUserInfo() {
                const { success, email, plan, usage } = await apiCall('/api/user/me', 'GET', null, true);
                if (success) {
                    ui.userInfo.innerHTML = `Logged in as <strong>${email}</strong> | Plan: <strong>${plan.toUpperCase()}</strong> | Usage: <strong>${usage}</strong>`;
                    ui.upgradeSection.hidden = (plan === 'pro');
                }
            }

            async function populateSelects() { /* ... same as before ... */ }
            function displayResults(copy) { /* ... same as before ... */ }
            function showError(id, msg) { /* ... same as before ... */ }
            function saveToken(token) { localStorage.setItem('authToken', token); }
            function getToken() { return localStorage.getItem('authToken'); }

            async function apiCall(endpoint, method = 'GET', body = null, secured = false) {
                try {
                    const headers = { 'Content-Type': 'application/json' };
                    if (secured) {
                        const token = getToken();
                        if (!token) throw new Error('Authentication token not found.');
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    const options = { method, headers, body: body ? JSON.stringify(body) : null };
                    const response = await fetch(endpoint, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    return { success: true, ...data };
                } catch (err) {
                    return { success: false, error: err.message };
                }
            }
        });
    </script>
</body>
</html>